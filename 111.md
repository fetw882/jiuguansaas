SillyTavern SaaS 化开发说明（无代码版）

约束与底线
	1.	禁止改动任何 SillyTavern 上游源码与构建物。
	2.	必须使用 MCP Playwright 浏览器进行实机联调与验收；出现任何错误，修复并硬刷新后确认消失才能继续。
	3.	首先完成“回环映射与可控读写”，多租户与计费后置但全程预留。

⸻

1. 目标与完成判定（DoD）

总体目标
• 在我方域名的 /st 路径下完整承载 SillyTavern 前端（不改上游）。
• 通过回环静态代理与统一 API 代理，将全部前端读写收敛至我方兼容层，数据入库。
• 支持卡密发放与续期；登录与邮箱密码绑定；首次登录执行引导初始化；登录后进入应用并实现个人数据隔离（多租户可开关）。

阶段性 DoD
• 阶段0：/st 正常渲染；静态资源无 4xx 或解码错误；/api/ping 返回 200 且为 JSON；未登录 API 报错为 JSON 而非 HTML。
• 阶段1：角色、聊天、设置、资产四大闭环均落库且可回显；所有写请求均具备 Authorization。
• 阶段2：已映射端点禁止回退上游（测试态开启 KillList）；未映射端点雷达为 0；多租户数据隔离通过用例。
• 阶段3：卡密与权益接口可用但不限额；后续可一键开启真实计费或限额。

⸻

2. 范围与不做事项

范围
• 回环静态代理与统一 API 代理（不改上游文件，仅通过响应改写与头部管理实现）。
• 兼容层网关、通用处理器与数据映射器，落库四闭环。
• 注入脚本职责：网络回环、交互兜底、观测埋点（仅外链注入，不写入上游）。
• 登录、卡密兑换、首登引导、权益查询。
• 多租户隔离能力可开关；数据库与 API 预留租户维度。

不做
• 修改或 Fork SillyTavern 源码。
• 真正的计费扣量与限额（首期只占位、只观测）。
• 为每个租户启动独立上游实例（先 Mirror/Bridge 方案）。

⸻

3. 架构与服务

服务与职责
• Web（Next，Node 运行时）：/st 静态回环；/api 统一代理；HTML 响应注入；错误 JSON 化；诊断头。
• API（Nest 兼容层）：统一网关、通用处理器、数据映射、鉴权守门、四闭环与卡密接口。
• ST-Upstream：原版 SillyTavern 上游，仅被动提供静态与未接管 API。
• PostgreSQL：持久化四闭环与账户、权益、卡密等数据。

环境约束
• 所有代理 RouteHandler 必须为 Node 运行时，以确保 WS/SSE 与头部透传。
• 如上游 CSP 过严，代理层负责放宽至允许我方域脚本与连接；禁止持久改动上游文件。

⸻

4. 研究与映射（不改源码）

目标与产物
• 静态研究：从上游产物中枚举所有网络端点与静态路径，产出端点清单。
• 运行观测：通过拦截 fetch/XHR 记录实际命中，产出命中日志。
• 兼容注册表：将必须接管的端点登记在映射清单；未登记的端点回退上游。
• KillList（测试环境）：对已接管端点禁止回退，若回退则直接阻断并返回明确错误。

⸻

5. Web 代理层需求（无示例）

静态回环
• 覆盖 css、js、img、images、locales、themes、assets、fonts、webfonts、backgrounds、sounds 等桶路径。
• 删除预压缩与长度相关头，避免解码失败；保留分段请求能力。
• 语言包大小写别名与回退策略。
• 禁用上游 Service Worker（代理层通过专门响应实现），避免缓存和作用域抢占。

HTML 注入
• 对所有 text/html 响应，在不触碰上游文件的前提下插入三类外链脚本：
	1.	观测脚本：页面就绪标记、错误收集、API 命中。
	2.	抓流量脚本：拦截前端网络请求并强制回环到我方 /api，补充鉴权头与观测打点。
	3.	交互桥脚本：对导入、上传等关键交互做兜底，保证可弹出文件选择并直传兼容接口。
• 如 CSP 限制导致注入失败，代理层负责放宽响应头中的安全策略，仅对我方域开放必要权限。

统一 API 代理
• 命中映射清单的请求转发到兼容层，未命中回退上游。
• 转发前进行鉴权兜底：从 st_access Cookie 注入 Authorization，必要时允许一次会话交换。
• 所有错误统一 JSON 化；永不返回 HTML 错误页面给前端。
• 诊断头要求：标记目标、鉴权来源、请求 ID 等，便于排障与追踪。

⸻

6. 兼容层需求（API）

认证与上下文
• 注册或登录接口：支持新用户注册与老用户登录；可选携带卡密完成一键开通。
• 登录成功签发包含用户与租户信息的访问令牌，并在 Cookie 中设置会话。
• 统一鉴权守门：兼容多种 Token 头格式；从代理注入优先读取；在请求上下文提供租户与用户信息。

卡密与权益
• 权益查询接口：未登录返回默认权益，已登录返回当前权益与到期时间。
• 卡密兑换接口：校验有效期、激活次数与频率；对同一租户的重复兑换保证幂等；成功后立刻可见新权益与新的到期时间。
• 首期仅占位，不触发真实限额；在响应头或日志返回当前权益以便观测。

四大闭环
• 角色：全部、创建、导入。
• 聊天：发送、历史。
• 设置：读取、保存（未登录读取默认，已登录返回个性化）。
• 资产：上传与访问。
• 输出统一：所有标识为字符串；内容类型固定为 JSON；错误统一格式。

只读端点
• groups、themes、worlds、backgrounds、tokenizers 等读路径，形状与状态码固定，空列表或兜底结构也须返回 200。

首次登录引导
• 幂等初始化接口：如用户设置不存在则写入默认，必要时植入示例数据。

⸻

7. 数据设计（概要）

核心实体
• 租户与用户：租户主键、用户主键与外键关联、唯一邮箱、密码摘要、创建时间。
• 权益：按租户维度记录计划、到期、月度配额、资产配额与更新时间。
• 卡密：卡种、有效期区间、时长、最大激活次数、已用次数与元数据。
• 兑换：记录卡密、租户、用户与兑换时间，用于幂等与审计。
• 四闭环：角色、聊天、用户设置、资产；全部包含租户维度与必要索引。
• 可选安全：开启行级安全策略，按租户维度限制查询。

⸻

8. 登录页与前端要求

登录页
• 提供邮箱、密码与可选卡密输入；自动判定注册或登录。
• 成功后设置会话 Cookie 并跳转进入应用。
• 显示权益卡片，定时刷新权益信息并提示到期。

应用页
• 保持注入三脚本生效；确保网络回环、交互兜底与观测打点均处于开启状态。
• 首次进入根据引导开关执行初始化；重复进入不重复创建数据。

⸻

9. MCP Playwright 实机测试规范

硬性联调规则
• 只能使用 MCP Playwright 浏览器；禁止随意关闭浏览器或开发者工具。
• 任何错误（控制台、网络、UI 提示）出现，必须先修复，并通过硬刷新确认错误消失后才能继续后续步骤。
• 禁止移除注入脚本或修改环境以规避断言。

阶段0：镜像可用
• /st 首屏渲染无错误；抽测 css、webfonts、backgrounds、sounds 等资源均返回成功；语言包可解析；心跳返回 200 JSON；未登录 API 错误为 JSON。
• 控制台存在注入脚本就绪日志；页面就绪标记返回真。

阶段1：登录、卡密与四闭环
• 新用户携带卡密注册并进入应用；权益信息正确展示。
• 老用户续期后到期时间延长并在界面可见。
• 角色创建与导入均可回显且刷新后仍在；聊天发送能在历史中看到；设置保存后可读取；资产上传可访问与显示。
• 所有写请求在网络面板必须具备 Authorization；响应头包含鉴权来源诊断信息。

阶段2：去上游化与多租户隔离
• 已接管端点不可回退上游；未映射端点雷达归零。
• 开启多租户后，账号 A 的数据在账号 B 不可见，返回前后一致。

必红集（应失败用例）
• 去掉 Authorization 的写请求返回鉴权错误且为 JSON。
• 非法格式或超大文件上传返回明确错误且为 JSON。
• 多租户场景下的跨租户访问返回禁止访问且为 JSON。

性能与产物
• 关键路径 p95 延迟具备记录与告警；首期为软门槛。
• CI 必须存档浏览器轨迹、视频、截图、API 命中数据与关键响应头快照；服务侧日志需包含请求路由、状态、耗时与租户/用户标识。

⸻

10. 里程碑与交付物

里程碑
• M0：镜像可用全绿。
• M1：登录、卡密、首登引导与四闭环全绿。
• M2：去上游化、未映射雷达归零与多租户隔离全绿。
• M3：稳定回归与性能达标；计费仍占位但接口可返回真实权益。

交付物
• 端点研究清单与运行命中记录。
• 代理配置、注入策略与映射清单（含 KillList）。
• 兼容层网关、处理器与映射器说明；统一错误与鉴权策略说明。
• 数据库实体与索引设计说明；行级安全策略（如启用）。
• E2E 用例清单、验收报告与 CI 产物归档。
• 问题修复记录：问题截图、根因一句话、修改位置与修复后截图，附关键诊断头信息。

⸻

11. 风险清单与对策

• 预压缩与响应头不当导致解码失败：通过代理删除相关头并直透字节流。
• 语言包大小写不一致：提供别名与回退策略。
• 上游 Service Worker 抢作用域：通过代理对相应路径返回空响应禁用。
• CSP 限制阻止注入：代理放宽脚本与连接源到我方域。
• 绝对路径与硬编码域名：代理重写或路径改写至 /st。
• 鉴权缺失导致 403：在代理确保注入鉴权；通过诊断头定位来源。
• HTML 错误穿透前端：统一错误 JSON 化。
• 上游版本漂移导致路径变化：每日对未映射端点进行雷达比对，发现差异立即修复。

⸻

12. 一句话原则

不改上游一行代码，把前端完整装进我方“兜里”（回环、注入、统一代理）；所有读写走我方兼容层，所有错误可观测可控制；全程用 MCP Playwright 浏览器实机点测，发现问题当场修复并刷新确认清零，再继续下一步。